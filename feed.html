<!DOCTYPE html>
<html>
<head>
	<title>vkfeed</title>
	<style type="text/css">
		.post{
			background-color: #13002f;
			overflow-wrap: anywhere;
			text-align: center;
			border-radius: 128px;
			margin: 16px;
		}
		body {
			background-color: #160057;
			color: #FFFFFF;
		}
	</style>
	<script type="text/javascript">

		function getScrollPercent() {
		var h = document.documentElement, 
			b = document.body,
			st = 'scrollTop',
			sh = 'scrollHeight';
			return (h[st]||b[st]) / ((h[sh]||b[sh]) - h.clientHeight);
		}

/*
		function getCookie(name) {
			let matches = document.cookie.match(new RegExp("(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"));
			return matches ? decodeURIComponent(matches[1]) : undefined;
		}

		function setCookie(name, value, options = {}) {
			options = {
				path: '/',
				// при необходимости добавьте другие значения по умолчанию
				...options
			};
			if (options.expires instanceof Date) {
				options.expires = options.expires.toUTCString();
			}
			let updatedCookie = encodeURIComponent(name) + "=" + encodeURIComponent(value);
			for (let optionKey in options) {
				updatedCookie += "; " + optionKey;
				let optionValue = options[optionKey];
				if (optionValue !== true) {
					updatedCookie += "=" + optionValue;
				}
			}
			document.cookie = updatedCookie;
		}

*/

		function setCookie(name,value){
			localStorage.setItem(name,value)
		}

		function getCookie(name){
			return localStorage.getItem(name)
		}

		////////////////////////////////////////////////////////////////////////////////////////////////
//			document.getElementById('body').innerHTML=i


		window.addEventListener('scroll',onscroll)
		window.addEventListener('DOMContentLoaded', onload)


		posts=[]
		shownposts=[]
		body=0
		start=0
		postsinpage=8
		scrolledto=0

		function onscroll(){
			//setCookie('y',Math.round(window.scrollY))
			newposts=getoverpage()
			if (newposts!=null){
				newposts-=start
				for (i=start+postsinpage;i<start+newposts+postsinpage&&i<posts.length;i++){
					if (posts[i].posted==0){
						body.innerHTML+=posttotext(posts[i])
						posts[i].posted=1
					}
				}
				start+=newposts
				if (start>posts.length){
					start=posts.length
				}
				if (start>scrolledto){
					scrolledto+=start
				}
				setCookie('start',posts[start].date)
			}
		}

		function getoverpage(st=null,fi=null){
			if (st==null){
				st=start
			}
			if (fi==null){
				fi=start+postsinpage
			}
			if (fi>posts.length){
				fi=posts.length
			}
			if (posts.length==0){
				console.log('len=0')
				return
			}
			if (document.getElementById('_'+st).getBoundingClientRect().bottom>=0){
				return 
			}
			if (fi<=st){
				console.log('len<0')
				return
			}
			if (fi-st==1){
				return st
			}
			ce=(fi+st)/2
			if (document.getElementById('_'+ce).getBoundingClientRect().bottom<0){
				return getoverpage(ce,fi)
			}
			return getoverpage(st,ce)
		}

/*		function onload(){
			first=document.getElementById('body').innerHTML.split('-->')[0]
			if (getCookie('first')==first){
				window.scrollTo(getCookie('y'))
			}else{
				setCookie('first',first)
			}
		}
*/

		function posttotext(q){
			text='<div class=post id=_'+q.index+'><br><h3>'+q.public+'</h3><h5>'+q.text+'</h5><br>'
			for (photo of q.photos){
				text+='<img src='+photo+' width="100%"><br>'
			}
			text+='\n<h3><a target="_blank" href=https://vk.com/wall'+q.orig+'><img src=orig.png width="64px"></a></h3><h6><br></h6></div>\n'
			return text
		}

		function up(){
			setCookie('up','1')
			document.location.reload()
		}

		function onload(){
			body=document.getElementById('body')
			fetch('/json').then(function(r) {
				r.json().then(function(json){
					posts=json
					start=0
					cs=getCookie('start')
					i=0
					if (getCookie('up')=='1'){
						setCookie('up','0')
						cs=null
					}
					for (post of posts){
						post.index=i
						post.posted=0
						if (cs==post.date){
							start=i
						}
						i++
					}
					scrolledto=start
					body.innerHTML=''
					for (i=start;i<posts.length&&i<postsinpage+start;i++){
						body.innerHTML+=posttotext(posts[i])
						posts[i].posted=1
					}
				})
			})
				}
	</script>
</head>
<body>
	<button onclick="up();return true">
		scroll up
	</button>
	<div id="body">
		loading...
	</div>
</body>
</html>
