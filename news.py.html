<!DOCTYPE html>
<html>
<head>
	<title>vkfeed</title>
	<style type="text/css">
		.post{
			border: 16px solid #160057;
			overflow-wrap: anywhere;
			text-align: center;
		}
		body {
			background-color: #13002f;
			color: #FFFFFF;
		}
	</style>
	<script type="text/javascript">

		posts=[]

		function getScrollPercent() {
		var h = document.documentElement, 
			b = document.body,
			st = 'scrollTop',
			sh = 'scrollHeight';
			return (h[st]||b[st]) / ((h[sh]||b[sh]) - h.clientHeight);
		}

		function getCookie(name) {
			let matches = document.cookie.match(new RegExp("(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"));
			return matches ? decodeURIComponent(matches[1]) : undefined;
		}

		function setCookie(name, value, options = {}) {
			options = {
				path: '/',
				// при необходимости добавьте другие значения по умолчанию
				...options
			};
			if (options.expires instanceof Date) {
				options.expires = options.expires.toUTCString();
			}
			let updatedCookie = encodeURIComponent(name) + "=" + encodeURIComponent(value);
			for (let optionKey in options) {
				updatedCookie += "; " + optionKey;
				let optionValue = options[optionKey];
				if (optionValue !== true) {
					updatedCookie += "=" + optionValue;
				}
			}
			document.cookie = updatedCookie;
		}

		function onscroll(){
			p=getScrollPercent();
			if (p>0.75){
				if (posts.length>0){
					p=posts[posts.length-1]
					load('page16'+p.split('-->')[0])
				}
				else{
					load()
				}
				setCookie('length',posts.length)
				var h = document.documentElement, 
					b = document.body,
					st = 'scrollTop',
					sh = 'scrollHeight';
					ss=(h[st]||b[st])
					setCookie('pix',ss)
			}
		}

		toscroll=-1

		function autoscroll(){
			if (posts.length>0){
					p=posts[posts.length-1]
					c=getCookie('length')
					toscroll=getCookie('pix')
					load('page'+c+p.split('-->')[0])
			}
			else{
				load()
			}
		}

		window.addEventListener('scroll',onscroll)
		window.addEventListener('DOMContentLoaded', onload)
		
		function onload(){
			load('load')
		}

		isnew=0

		function scroller(){
			window.scrollTo(0,toscroll)
			toscroll=-1
		}

		function load(url=''){
			fetch('/'+url).then(function(r){
				r.json().then(function(j){
					for (s of j){
						posts.push(s)
					}
					isnew=1
					if (toscroll!=-1){
						setTimeout(scroller,1000)
					}
				})
			})
		}

		function show(){
			if (isnew==0){
				return
			}
			isnew=0
			html=''
			posts=posts.filter((post,pos) => {
				return posts.indexOf(post)==pos
			})
			for (post of posts){
				html+=post
			}
			document.getElementById('body').innerHTML=html
		}

		setInterval(show,1000)

	</script>
</head>
<body>
	<button onclick="autoscroll();return false">scroll down</button>
	<div id="body"></div>
</body>
</html>
